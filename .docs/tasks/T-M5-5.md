# T-M5-5: チャット画面へのカスタムコマンド切替統合

| 項目 | 内容 |
|------|------|
| マイルストーン | M5 |
| 依存 | T-M5-2, T-M5-3 |
| 要件ID | FR-016, FR-017, FR-018 |

## 説明
ask-ai チャット画面にカスタムコマンド切替ドロップダウンを追加し、会話ごとにカスタムコマンド（システムプロンプト + モデル）を切り替えられるようにする。

## 作業内容
1. `src/ask-ai.tsx` に `List.Dropdown`（searchBarAccessory）を追加:
   - 選択肢:
     - 「デフォルト」（value: ""）: Preferences の systemPrompt を使用
     - ユーザー作成の各カスタムコマンド（value: customCommand.id）
   - `useCustomCommands` フックでカスタムコマンド一覧を取得
   - ドロップダウンの変更時:
     - 現在の Thread の `customCommandId` を更新（`""` の場合は undefined に設定）
     - LocalStorage のスレッド一覧を更新
2. `src/hooks/useConversation.ts` の `sendMessage()` を拡張:
   - 現在の Thread の `customCommandId` を参照
   - `customCommandId` がある場合:
     - `getCustomCommand()` で該当コマンドを取得
     - 取得成功: そのコマンドの `systemPrompt` を使用
     - 取得失敗（削除済み）: Preferences の `systemPrompt` にフォールバック
   - `customCommandId` がない場合: Preferences の `systemPrompt` を使用（T-M5-2 の実装）
   - システムプロンプト（trim 後が空でなければ）を `role: "system"` として `trimMessagesForContext()` 呼び出し前に配列へ追加（トークン上限計算に含める）
3. モデル優先順位の実装:
   - `customCommandId` がある場合:
     - CustomCommand.model が指定されていれば、そのモデルを使用
     - CustomCommand.model が未指定なら Preferences.model を使用
   - `customCommandId` がない場合: Preferences.model を使用
   - `createChatCompletion()` の `model` パラメータに決定したモデルを渡す
4. `useConversation` フックに `updateThreadCustomCommand(threadId, customCommandId)` 関数を追加:
   - Thread の `customCommandId` を更新し、LocalStorage に保存
5. 新規スレッド作成時の `customCommandId` 引き継ぎ:
   - `createThread()` にオプショナルな `customCommandId` パラメータを追加
   - AI Commands 一覧から会話を開始する場合に使用

## 設計上の注意
- Thread は `customCommandId` で参照のみ持つ（スナップショットではなく常に最新を参照）
- 削除済みコマンドの場合は Preferences デフォルトにフォールバック
- `openai.ts` は変更不要（既存の system -> instructions 変換がそのまま活きる）
- 既存の Thread データは `customCommandId` が undefined で問題なく動作する（データ移行不要）

## タスクのチェックリスト
- [ ] チャット画面にカスタムコマンドドロップダウンが表示される
- [ ] ドロップダウンに「デフォルト」と全カスタムコマンドが列挙される
- [ ] ドロップダウン切替で Thread の customCommandId が更新される
- [ ] カスタムコマンドのシステムプロンプトが送信時に注入される
- [ ] カスタムコマンドのモデルが Preferences より優先される
- [ ] 削除済みカスタムコマンドの場合にデフォルトにフォールバックする
- [ ] 既存の Thread データ（customCommandId なし）が問題なく動作する
- [ ] LocalStorage の会話履歴にシステムプロンプトが保存されないことを確認
