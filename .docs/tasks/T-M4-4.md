# T-M4-4: 履歴上限管理の実装

| 項目 | 内容 |
|------|------|
| マイルストーン | M4 |
| 依存 | T-M4-1 |
| 要件ID | FR-012 |

## 説明
会話が長くなりトークン数が API の上限を超える場合に、古いメッセージを切り捨てて送信する仕組みを実装する。

## 作業内容
1. トークン数の簡易推定関数を実装:
   - 英語: 約4文字 = 1トークン / 日本語: 約1.5文字 = 1トークン の簡易計算
   - 精密なトークナイザは不要（概算で十分）
2. createChatCompletion() の呼び出し前にトークン数チェックを追加:
   - モデルごとのコンテキスト上限を定義（gpt-4o-mini: 128k）
   - 応答用のバッファ（例: 4096トークン）を確保
3. 上限超過時の切り捨てロジック:
   - system メッセージは常に保持
   - 古いメッセージから順に除外
   - 最低限、最新のユーザーメッセージは保持
4. 切り捨てが発生した場合、Toast で通知

## タスクのチェックリスト
- [ ] トークン数の簡易推定が動作する
- [ ] 上限超過時に古いメッセージが切り捨てられる
- [ ] system メッセージが切り捨て対象から除外される
- [ ] 最新のユーザーメッセージが常に保持される
- [ ] 切り捨て発生時にユーザーへ通知される
