# Project Autopilot - 自動実装オーケストレーター

仕様書・ロードマップを確認した上で、実装→レビュー→最終化までを自動実行します。

## パラメータ

| 引数          | 既定  | 説明                           |
| ------------- | ----- | ------------------------------ |
| --start    | -     | 開始タスクID（途中から再開時） |
| --end      | -     | 中断タスクID（途中まで実装） |


### 使用例

```bash
# 基本的な使用
/project-autopilot

# 特定タスクから再開
/project-autopilot --start=T-M2-3
```


## 実行手順

フェーズ1 ~ フェーズ3 を順に実行します。

### Phase 1: タスクの確認

```bash
Read .docs/roadmap.md
```

roadmap.md から未完了タスク（⬜ / 🔄）を抽出し、次に取り掛かるべきタスクを確認します。
すべて完了済みの場合は Phase 3 へスキップ。

`--start` が指定されている場合は、そのタスクから取り掛かります。
`--end` が指定されている場合は、その指定されたタスク番号まで完了後、 Phase 2 のループを終了し Phase 3 へ進みます。

### Phase 2: 実装ループ

#### 実装ループ処理

未完了タスクがなくなるまで、以下を繰り返す。

**各タスク開始時に `TodoWrite` で以下を登録し、すべて `completed` になるまで Phase 3 には進まないこと。

- [ ] Step 2-1: base_branch 確認
- [ ] Step 2-2: ブランチ作成
- [ ] Step 2-3: サブエージェントで実装
- [ ] Step 2-4: squash merge
- [ ] Step 2-5: マイルストーン進捗チェック（2-1 へ戻るか、2-6 へ進む）
- [ ] Step 2-6: マイルストーン実装後の仕様書更新
- [ ] Step 2-7: コードレビュー


#### Step 2-1: base_branch の確認

現在のブランチが `base_branch`（implement.json で定義）と一致していることを確認します。


```bash
Read .docs/implement.json
```

```bash
git branch --show-current
git status
```

もし未コミットの変更があれば、一時停止してユーザーに確認すること。

#### Step 2-2: タスクブランチ作成

タスク実装用のブランチを作成します。

```bash
git checkout -b task/T-M{X}-{N}
```


#### Step 2-3: サブエージェントで実装

Task ツールで `task-implementer-opus` を呼び出し、以下のようにタスク ID を渡して実装を依頼します。

```
T-M{X}-{N} を実装してください。
```

サブエージェントによる実装が完了後 → **Step 2-4 へ進む**


##### エラー時の対応

サブエージェントがエラーを返した場合、ベースブランチに戻り、**タスクブランチを破棄します**:

```bash
# 変更を破棄して base_branch に戻る
git checkout {base_branch}

# タスクブランチを強制削除
git branch -D task/T-M{X}-{N}
```

その後、ユーザーに通知して選択肢を提示:

```md
## タスク T-M{X}-{N} でエラー発生。作業ブランチを破棄しました。

[エラー内容をユーザーに報告]

選択肢:
1. リトライ - ブランチを再作成してタスクを最初からやり直す
2. スキップ - このタスクをスキップして次へ（ROADMAP は ⬜ のまま）
3. 中止 - autopilot を中断
```


#### Step 2-4: サブエージェントで実装後、squash merge

⚠️ **このステップは必須です。次のタスクに進む前に必ず実行してください。**

サブエージェントによる実装が正常に完了したら、ベースブランチへ戻ってコミットをまとめます。

以下を実行:
```bash
# base_branch に戻る
git checkout {base_branch}

# squash merge
git merge --squash task/T-M{X}-{N}

# コミット
git commit -m "feat(T-M{X}-{N}): {タスク名}"

# タスクブランチを削除
git branch -D task/T-M{X}-{N}
```

**実行後** → マイルストーン進捗チェックへ進む。



#### Step 2-5: マイルストーン進捗チェック

roadmap.md を確認し、直前の作業タスクを含む現在のマイルストーン（ M{X} ）の全タスクが完了したか（✅ になっているか）を確認する。
その進捗度合いに応じ、以下のいずれかへ分岐して下さい。

1. **同じマイルストーン内に未完了タスクがある場合**:

Step 2-1 に戻り、次のタスクを実装してください。

2. **マイルストーン完了時**: Step 2-6 へ進む


#### Step 2-6: 仕様書の更新

仕様書（`.docs/spec.md`）を更新します。

Task ツールで サブエージェント `document-editor` を呼び出し、以下のプロンプトを実行:
```
/docs-spec action=update

マイルストーン M{X} の実装が完了しました。
このマイルストーンで実装した全タスクの内容を踏まえ、ドキュメントと実際のコードの整合性を確認し、必要に応じてドキュメントを更新してください。

## 完了したタスク
[M{X} で完了したタスク一覧を記載]
```

仕様書が更新されたら、コミット:
```bash
git add .docs/project_spec.md
git commit -m "docs: M{X} 仕様書更新"
```


コミットできたら、Codexによるレビューへ進みます。


#### Step 2-7: コードレビュー

まず、マイルストーン開始時点の最初のタスクを実装したコミットを特定:

```bash
# マイルストーン M{X} の最初のタスク開始コミットを探す
git log --oneline --grep="start T-M{X}-" | tail -1
```

このコミットハッシュを `{from}` とし、作業範囲を指定してCodexにレビューを依頼:

```md
/codex-review --target={from}...HEAD --auto-commit

マイルストーン M{X}を実装後、それに合わせて仕様書も更新しました。
コードレビューを優先しつつ、仕様書の更新に不備がないかもチェックしてください。

## マイルストーンの概要
[マイルストーンの説明と各タスクの作業内について概要を伝える]
```

レビューで指摘があれば修正し、`ok: true` になるまで**反復**すること。


---

### Phase 3: 完了報告

完了報告をして終了する。

```markdown
**実装完了**
autopilotが終了しました。

- 総タスク数: X
- レビュー回数: Y
```

